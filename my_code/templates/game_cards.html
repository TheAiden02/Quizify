{% extends 'base.html' %}

{% block question %}
{% if game_length == 0 %}
    {% set game_length = '∞' %}
{% endif %}
<h2>
    Question: {{ question }} / {{ game_length }}
</h2>
{% endblock %}

{% block header %}
  <h1>{% block title %}game cards{% endblock %}</h1>
{% endblock %}


{% block content %}
   
        <h1>Select the more popular song from below:</h1>

        <ul>
            <form class="cards" method="post" >
                <li>        
                    <h3 class="popReveal">Popularity: {{choices[0]['popularity']}}</h3>
                    <label>
                        <button type="submit" name="selected_track" value="{{ choices[0]['name'] }}" class="gamecard" data-track="{{choices[0]}}" data-track-uri="{{choices[0]['uri']}}">
                        <img src="{{ choices[0]['album']['images'][1]['url'] }}">
                    </label>
                    <span class="trackName">
                        <span class="title"> {{ choices[0]['name'] }}</span> by <span class="artist">{{ choices[0]['artists'] }}</span>
                    </span>
                </li>
                <li>
                    <h3 class="popReveal">Popularity: {{choices[1]['popularity']}}</h3>
                    <label>
                        <button type="submit" name="selected_track" value="{{ choices[1]['name'] }}" class="gamecard" data-track="{{choices[1]}}" data-track-uri="{{choices[1]['uri']}}">
                        <img src="{{ choices[1]['album']['images'][1]['url'] }}">
                    </label>
                    <span class="trackName">
                        <span class="title"> {{ choices[1]['name'] }}</span> by <span class="artist">{{ choices[1]['artists'] }}</span>
                    </span>
                </li>
            </form>
        </ul>
        <div id="result"></div>
        <form action="{{ url_for('grade') }}">
            <input id="endButton" type="submit"  value="End game">
        </form>         
{% endblock %}

{% block javascript %}
<script>
let correct

document.addEventListener("DOMContentLoaded", function() {
    const buttons = document.querySelectorAll(".gamecard");
    const resultDiv = document.getElementById("result");
    const popReveals = document.querySelectorAll(".popReveal")

    popReveals.forEach(pop =>{
        pop.classList.add("hidden")
    })

    buttons.forEach(button => {
        button.addEventListener("click", function(event) {
            event.preventDefault();  // Prevent full page reload

            let selectedSong = this.getAttribute("data-track");
            // let selectedSongUri = this.getAttribute("data-track-uri")

            fetch("/game_cards", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: "selected_track=" + encodeURIComponent(selectedSong)
            })
            .then(response => response.json())
            .then(data => {
                let button_text = ""
                if(data.last_question){
                    button_text = "Final score"
                } else{
                    button_text = "Next"
                }

                popReveals.forEach(pop =>{
                    pop.classList.remove("hidden")
                })

                // Show the result
                resultDiv.innerHTML = `
                    <p>${data.is_correct ? "✅ Correct!" : "❌ Incorrect"}</p>
                    <p>Score: ${data.score}</p>
                    <button id="nextQuestion">${button_text}</button>
                `;
                // Disable buttons so the user can't select again
                buttons.forEach(btn => {
                    btn.disabled = true
                    if (btn.getAttribute("data-track-uri") === data.correct_song){
                        btn.classList.add("correct")
                    }
                    else{
                        btn.classList.add("incorrect")
                    }
                });
            
                // Add event listener for the "Next" button
                document.getElementById("nextQuestion").addEventListener("click", function() {
                    // Since this redirects to a literal url, it needs to be updated whenever we start properly hosting quizify
                    if (data.last_question){
                        location.href = "http://localhost:5000/grade" // Go to grade page
                        } 
                    else{
                        location.reload() // Load next question
                    }
                });
                

            })
            .catch(error => console.error("Error:", error));
        });
    });
});



</script>
{% endblock %}